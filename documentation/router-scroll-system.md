# Syst√®me de Routage et Scroll - CodeurBase

## üìã Table des mati√®res

1. [Architecture g√©n√©rale](#architecture-g√©n√©rale)
2. [Syst√®me de routage](#syst√®me-de-routage)
3. [Store de navigation](#store-de-navigation)
4. [Syst√®me de scroll Lenis](#syst√®me-de-scroll-lenis)
5. [Gestion du localStorage](#gestion-du-localstorage)
6. [Synchronisation URL](#synchronisation-url)
7. [Gestion des transitions](#gestion-des-transitions)
8. [API et m√©thodes](#api-et-m√©thodes)
9. [D√©pannage](#d√©pannage)

---

## üèóÔ∏è Architecture g√©n√©rale

### Vue d'ensemble

Le syst√®me de navigation de CodeurBase est bas√© sur une architecture SPA (Single Page Application) avec :

- **Store centralis√©** : `currentPage` pour la gestion de l'√©tat
- **Synchronisation URL** : Mise √† jour automatique de l'URL du navigateur
- **Persistance** : Sauvegarde dans `localStorage`
- **Scroll smooth** : Gestion centralis√©e avec Lenis
- **Transitions** : Reset automatique du scroll entre les pages

### Composants principaux

```
App.svelte (Root)
‚îú‚îÄ‚îÄ currentPage Store (router.js)
‚îú‚îÄ‚îÄ Lenis Store (lenis.js)
‚îú‚îÄ‚îÄ Navbar (navigation)
‚îî‚îÄ‚îÄ Pages
    ‚îú‚îÄ‚îÄ Acceuil.svelte
    ‚îú‚îÄ‚îÄ AcceuilPortfolioBis.svelte
    ‚îú‚îÄ‚îÄ Blog.svelte (about)
    ‚îú‚îÄ‚îÄ Contact.svelte
    ‚îú‚îÄ‚îÄ Login.svelte
    ‚îî‚îÄ‚îÄ AdminBoard.svelte (admin)
```

---

## üß≠ Syst√®me de routage

### Pages disponibles

```javascript
const validPages = [
  'acceuil',           // Page d'accueil principale
  'acceuilPortfolioBis', // Page portfolio avanc√©e
  'about',             // Blog (alias pour about)
  'contact',           // Page de contact
  'login',             // Page de connexion
  'admin'              // Tableau de bord admin
];
```

### Logique de routage

#### 1. **Priorit√© de r√©solution**
```javascript
// Ordre de priorit√© pour d√©terminer la page initiale :
1. URL du navigateur (window.location.pathname)
2. localStorage (currentPage)
3. Page par d√©faut ('acceuil')
```

#### 2. **Validation des pages**
- Toutes les pages doivent √™tre dans `validPages`
- Redirection automatique vers `'acceuil'` si page invalide
- Logs d'erreur pour les tentatives de navigation invalides

#### 3. **Gestion des URLs**
- **Format** : `https://domain.com/pageName`
- **Nettoyage** : Suppression du `/` initial
- **Synchronisation** : URL ‚Üî Store ‚Üî localStorage

---

## üì¶ Store de navigation

### Structure du store

```javascript
// stores/router.js
export const currentPage = createCurrentPageStore();

// M√©thodes disponibles :
currentPage.subscribe(callback)  // S'abonner aux changements
currentPage.set(newPage)         // Changer de page
currentPage.get()                // Obtenir la page actuelle
```

### Fonctionnement interne

#### 1. **Initialisation**
```javascript
function createCurrentPageStore() {
  // 1. Lire l'URL actuelle
  const urlPage = getPageFromURL();
  
  // 2. Lire le localStorage
  const storedPage = localStorage.getItem('currentPage');
  
  // 3. D√©terminer la page initiale
  const initialPage = urlPage !== 'acceuil' 
    ? urlPage 
    : (validPages.includes(storedPage) ? storedPage : 'acceuil');
  
  // 4. Cr√©er le store Svelte
  const store = writable(initialPage);
}
```

#### 2. **Changement de page**
```javascript
set: (newValue) => {
  // 1. Validation
  if (!validPages.includes(newValue)) {
    console.error(`Invalid page value: ${newValue}`);
    return;
  }
  
  // 2. V√©rification de changement
  if (currentValue !== newValue) {
    // 3. Mise √† jour du store
    store.set(newValue);
    currentValue = newValue;
    
    // 4. Persistance
    localStorage.setItem('currentPage', newValue);
    
    // 5. Synchronisation URL
    window.history.pushState({}, '', `/${newValue}`);
  }
}
```

#### 3. **√âcoute des changements d'URL**
```javascript
// Gestion du bouton retour/avancer du navigateur
window.addEventListener('popstate', () => {
  const page = getPageFromURL();
  if (page !== currentValue) {
    store.set(page);
    currentValue = page;
    localStorage.setItem('currentPage', page);
  }
});
```

---

## üéØ Syst√®me de scroll Lenis

### Architecture centralis√©e

#### 1. **Instance unique**
```javascript
// stores/lenis.js
let lenisInstance = null;  // Instance globale unique
let rafId = null;          // ID de la boucle RAF
let isRafActive = false;   // √âtat de la boucle RAF
```

#### 2. **Configuration Lenis**
```javascript
lenisInstance = new Lenis({
  duration: 5,                    // Dur√©e de l'animation (plus lent)
  easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)), // Courbe d'easing
  direction: 'vertical',          // Direction du scroll
  smooth: true,                   // Activation du smooth scroll
  mouseMultiplier: 60,            // Sensibilit√© souris (plus lent)
  smoothTouch: true,              // Smooth scroll sur mobile
  touchMultiplier: 0.6,           // Sensibilit√© tactile (plus lent)
});
```

### Gestion du RAF (RequestAnimationFrame)

#### 1. **Boucle RAF centralis√©e**
```javascript
function startRaf() {
  if (isRafActive || !lenisInstance) return;
  
  isRafActive = true;
  function raf(time) {
    if (isRafActive && lenisInstance) {
      lenisInstance.raf(time);
      rafId = requestAnimationFrame(raf);
    }
  }
  rafId = requestAnimationFrame(raf);
}
```

#### 2. **Arr√™t du RAF**
```javascript
function stopRaf() {
  isRafActive = false;
  if (rafId) {
    cancelAnimationFrame(rafId);
    rafId = null;
  }
}
```

### API Lenis

#### 1. **Initialisation**
```javascript
// Cr√©er ou r√©cup√©rer l'instance
const lenisInstance = initLenis();

// R√©cup√©rer l'instance existante
const lenisInstance = getLenis();
```

#### 2. **Contr√¥le**
```javascript
stopLenis();    // Arr√™ter le scroll smooth
startLenis();   // Red√©marrer le scroll smooth
destroyLenis(); // D√©truire compl√®tement l'instance
```

#### 3. **Navigation programmatique**
```javascript
// Scroll vers une position
lenisInstance.scrollTo(0, { immediate: true }); // En haut, imm√©diat
lenisInstance.scrollTo(1000);                   // √Ä 1000px, anim√©

// Scroll vers un √©l√©ment
lenisInstance.scrollTo('#element', { offset: -100 });
```

---

## üíæ Gestion du localStorage

### Structure des donn√©es

```javascript
// Cl√© utilis√©e
const STORAGE_KEY = 'currentPage';

// Valeurs possibles
const validPages = ['acceuil', 'acceuilPortfolioBis', 'about', 'contact', 'login', 'admin'];
```

### Op√©rations

#### 1. **Lecture**
```javascript
const storedPage = localStorage.getItem('currentPage');
```

#### 2. **√âcriture**
```javascript
localStorage.setItem('currentPage', newPage);
```

#### 3. **Validation**
```javascript
// V√©rifier si la valeur est valide
if (validPages.includes(storedPage)) {
  // Utiliser la valeur
} else {
  // Utiliser la valeur par d√©faut
}
```

### Synchronisation

#### 1. **Store ‚Üí localStorage**
```javascript
// √Ä chaque changement de page
currentPage.set('newPage');
// ‚Üí localStorage.setItem('currentPage', 'newPage');
```

#### 2. **localStorage ‚Üí Store**
```javascript
// Au chargement initial
const storedPage = localStorage.getItem('currentPage');
const initialPage = validPages.includes(storedPage) ? storedPage : 'acceuil';
```

---

## üîó Synchronisation URL

### M√©canisme de synchronisation

#### 1. **Store ‚Üí URL**
```javascript
// Lors du changement de page
currentPage.set('about');
// ‚Üí window.history.pushState({}, '', '/about');
```

#### 2. **URL ‚Üí Store**
```javascript
// Au chargement et navigation navigateur
window.addEventListener('popstate', () => {
  const page = getPageFromURL();
  currentPage.set(page);
});
```

### Gestion des URLs

#### 1. **Format des URLs**
```
https://codeurbase.fr/acceuil
https://codeurbase.fr/about
https://codeurbase.fr/contact
```

#### 2. **Nettoyage des paths**
```javascript
const path = window.location.pathname.replace(/^\//, ''); // Retire le / initial
```

#### 3. **Redirection automatique**
```javascript
// Si l'URL ne correspond pas √† la page actuelle
if (currentPath !== initialPage) {
  window.history.replaceState({}, '', `/${initialPage}`);
}
```

---

## üîÑ Gestion des transitions

### Reset automatique du scroll

#### 1. **D√©tection du changement de page**
```javascript
// Dans App.svelte
let previousPage = null;

$: {
  // Reset scroll en haut lors du changement de page
  if (previousPage && previousPage !== $currentPage) {
    const lenisInstance = getLenis();
    if (lenisInstance) {
      lenisInstance.scrollTo(0, { immediate: true });
    }
  }
  previousPage = $currentPage;
}
```

#### 2. **Comportement intelligent**
- **Changement de page** ‚Üí Reset en haut
- **Rechargement** ‚Üí Pas de reset (position conserv√©e)
- **Arriv√©e directe** ‚Üí Reset initial

#### 3. **Reset initial**
```javascript
// Au chargement de l'app
if (lenisInstance) {
  lenisInstance.scrollTo(0, { immediate: true });
}
```

### Gestion des composants

#### 1. **Pages principales**
```javascript
// Chaque page r√©cup√®re l'instance Lenis existante
onMount(() => {
  const lenisInstance = getLenis();
  // Pas de cr√©ation d'instance, r√©utilisation
});
```

#### 2. **Nettoyage**
```javascript
onDestroy(() => {
  // Pas de nettoyage Lenis, g√©r√© globalement
  // Seulement le nettoyage des animations GSAP
});
```

---

## üõ†Ô∏è API et m√©thodes

### Store de navigation

#### `currentPage.subscribe(callback)`
```javascript
// S'abonner aux changements de page
const unsubscribe = currentPage.subscribe(page => {
  console.log('Page actuelle:', page);
});
```

#### `currentPage.set(newPage)`
```javascript
// Changer de page
currentPage.set('about');
```

#### `currentPage.get()`
```javascript
// Obtenir la page actuelle
const current = currentPage.get();
```

### Store Lenis

#### `initLenis()`
```javascript
// Cr√©er ou r√©cup√©rer l'instance Lenis
const lenisInstance = initLenis();
```

#### `getLenis()`
```javascript
// R√©cup√©rer l'instance existante
const lenisInstance = getLenis();
```

#### `stopLenis()`
```javascript
// Arr√™ter le scroll smooth
stopLenis();
```

#### `startLenis()`
```javascript
// Red√©marrer le scroll smooth
startLenis();
```

#### `destroyLenis()`
```javascript
// D√©truire compl√®tement l'instance
destroyLenis();
```

### Navigation programmatique

#### Scroll vers position
```javascript
const lenisInstance = getLenis();
lenisInstance.scrollTo(0);                    // En haut
lenisInstance.scrollTo(1000);                 // √Ä 1000px
lenisInstance.scrollTo(0, { immediate: true }); // Imm√©diat
```

#### Scroll vers √©l√©ment
```javascript
lenisInstance.scrollTo('#element');
lenisInstance.scrollTo('#element', { offset: -100 });
```

---

## üîß D√©pannage

### Probl√®mes courants

#### 1. **Scroll ne fonctionne pas**
```javascript
// V√©rifier que Lenis est initialis√©
const lenisInstance = getLenis();
if (!lenisInstance) {
  console.error('Lenis non initialis√©');
}

// V√©rifier que le RAF est actif
console.log('RAF actif:', isRafActive);
```

#### 2. **Page ne change pas**
```javascript
// V√©rifier que la page est valide
const validPages = ['acceuil', 'acceuilPortfolioBis', 'about', 'contact', 'login', 'admin'];
if (!validPages.includes(newPage)) {
  console.error('Page invalide:', newPage);
}
```

#### 3. **URL non synchronis√©e**
```javascript
// V√©rifier l'URL actuelle
console.log('URL actuelle:', window.location.pathname);
console.log('Page store:', currentPage.get());
console.log('localStorage:', localStorage.getItem('currentPage'));
```

#### 4. **Scroll ne se reset pas**
```javascript
// V√©rifier la d√©tection de changement de page
console.log('Page pr√©c√©dente:', previousPage);
console.log('Page actuelle:', $currentPage);
```

### Logs de debug

#### 1. **Activer les logs Lenis**
```javascript
// Dans lenis.js
console.log('[Lenis] Cr√©ation d\'une nouvelle instance');
console.log('[Lenis] R√©utilisation de l\'instance existante');
console.log('[Lenis] RAF d√©marr√©');
console.log('[Lenis] RAF arr√™t√©');
```

#### 2. **Activer les logs de navigation**
```javascript
// Dans App.svelte
console.log(`[App] Changement de page: ${previousPage} ‚Üí ${$currentPage}`);
console.log('[App] Reset scroll initial en haut');
```

#### 3. **Activer les logs de store**
```javascript
// Dans router.js
console.log('Page actuelle:', currentValue);
console.log('Nouvelle page:', newValue);
```

### Solutions

#### 1. **R√©initialiser Lenis**
```javascript
destroyLenis();
const lenisInstance = initLenis();
```

#### 2. **Forcer le reset du scroll**
```javascript
const lenisInstance = getLenis();
if (lenisInstance) {
  lenisInstance.scrollTo(0, { immediate: true });
}
```

#### 3. **Vider le localStorage**
```javascript
localStorage.removeItem('currentPage');
// Recharger la page
window.location.reload();
```

---

## üìä Diagrammes

### Flux de navigation

```mermaid
graph TD
    A[Utilisateur clique] --> B[currentPage.set()]
    B --> C[Validation page]
    C --> D[Store mis √† jour]
    D --> E[localStorage mis √† jour]
    E --> F[URL mise √† jour]
    F --> G[Composant rendu]
    G --> H[Reset scroll]
    
    I[URL directe] --> J[getPageFromURL()]
    J --> K[Validation page]
    K --> L[Store initialis√©]
    L --> M[localStorage synchronis√©]
    M --> N[Composant rendu]
```

### Architecture Lenis

```mermaid
graph TD
    A[App.svelte] --> B[initLenis()]
    B --> C[Instance unique]
    C --> D[RAF centralis√©]
    D --> E[Scroll smooth]
    
    F[Pages] --> G[getLenis()]
    G --> C
    
    H[Changement page] --> I[Reset scroll]
    I --> J[scrollTo(0)]
```

---

## üéØ Bonnes pratiques

### 1. **Utilisation du store**
```javascript
// ‚úÖ Bon
currentPage.set('about');

// ‚ùå √âviter
window.location.href = '/about';
```

### 2. **Gestion Lenis**
```javascript
// ‚úÖ Bon - R√©cup√©rer l'instance existante
const lenisInstance = getLenis();

// ‚ùå √âviter - Cr√©er une nouvelle instance
const lenisInstance = initLenis();
```

### 3. **Nettoyage**
```javascript
// ‚úÖ Bon - Pas de nettoyage Lenis dans les pages
onDestroy(() => {
  // Seulement GSAP et autres ressources
});

// ‚ùå √âviter - D√©truire Lenis dans les pages
onDestroy(() => {
  lenisInstance.destroy();
});
```

---

## üìù Changelog

### Version 1.0.0
- ‚úÖ Syst√®me de routage SPA
- ‚úÖ Synchronisation URL ‚Üî Store ‚Üî localStorage
- ‚úÖ Scroll smooth centralis√© avec Lenis
- ‚úÖ Reset automatique du scroll entre pages
- ‚úÖ Gestion des transitions intelligentes
- ‚úÖ Support des boutons navigateur (retour/avancer)

---

*Documentation g√©n√©r√©e le 16/10/2025 - CodeurBase.fr*
